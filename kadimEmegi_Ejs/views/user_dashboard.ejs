<%- include('partials/header', { title: 'Kullanıcı Dashboard' }) %>
<h1>Hoş Geldiniz, <%= user.first_name %> <%= user.last_name %></h1>

<h2>Tüm İlanlar</h2>
<% if (allListings.length > 0) { %>
  <ul>
    <% allListings.forEach(listing => { %>
      <li>
        <strong><%= listing.title %></strong> - <%= listing.price %> TL
        <br>
        <small>Ekleyen: <%= listing.username %></small>
        <br>
        <small>Kategori: <%= listing.category %></small>
        <br>
        <small>Açıklama: <%= listing.description %></small>
        <br>
        <img src="<%= listing.image_path %>" alt="<%= listing.title %>" style="max-width: 200px;">
        
        <!-- Sepete Ekle Butonu -->
        <form method="POST" action="/cart/add">
          <input type="hidden" name="listing_id" value="<%= listing.id %>">
          <input type="number" name="quantity" value="1" min="1">
          <button type="submit">Sepete Ekle</button>
        </form>

        <!-- Mesaj Gönder Butonu -->
        <button class="message-button" data-listing-id="<%= listing.id %>">Mesaj Gönder</button>
        
        <!-- Mesaj Gönderme Formu -->
        <div class="message-form" id="message-form-<%= listing.id %>" style="display: none;">
          <form method="POST" action="/messages/send">
            <input type="hidden" name="receiver_id" value="<%= listing.user_id %>">
            <label for="content-<%= listing.id %>">Mesaj:</label>
            <textarea name="content" id="content-<%= listing.id %>" required></textarea>
            <br>
            <button type="submit">Gönder</button>
          </form>
        </div>
      </li>
    <% }); %>
  </ul>
<% } else { %>
  <p>Henüz bir ilan eklenmedi.</p>
<% } %>

<hr>

<h2>Senin İlanların</h2>
<% if (userListings.length > 0) { %>
  <ul>
    <% userListings.forEach(listing => { %>
      <li>
        <strong><%= listing.title %></strong> - <%= listing.price %> TL
        <br>
        <a href="/listings/<%= listing.id %>/edit">Düzenle</a> |
        <a href="/listings/<%= listing.id %>/delete" onclick="return confirm('Bu ilanı silmek istediğinize emin misiniz?')">Sil</a>
      </li>
    <% }); %>
  </ul>
<% } else { %>
  <p>Henüz bir ilan eklemediniz.</p>
<% } %>


<h2>Sertifikalarınız</h2>
<% if (certificates.length > 0) { %>
  <ul>
    <% certificates.forEach(certificate => { %>
      <li>
        <h3><%= certificate.certificate_name %></h3>
        <img src="<%= certificate.certificate_path %>" alt="<%= certificate.certificate_name %>" />
        <a href="/certificates/<%= certificate.id %>/delete">Sil</a>
      </li>
    <% }); %>
  </ul>
<% } else { %>
  <p>Henüz sertifikanız yok.</p>
  <a href="/certificates/upload">Yeni Sertifika Ekle</a>
<% } %>
<h2>Sepetiniz</h2>
<% if (cartItems.length > 0) { %>
  <ul>
    <% cartItems.forEach(item => { %>
      <li>
        <strong><%= item.title %></strong> - <%= item.quantity %> adet - <%= item.price * item.quantity %> TL
        <br>
        <img src="<%= item.image_path %>" alt="<%= item.title %>" style="max-width: 200px;">
        
        <!-- Sepetten Çıkarma Butonu -->
        <form method="POST" action="/cart/remove">
          <input type="hidden" name="cartId" value="<%= item.id %>">
          <button type="submit">Sepetten Çıkar</button>
        </form>
      </li>
    <% }); %>
  </ul>
  <a href="/orders/checkout">Ödeme Sayfasına Git</a>
<% } else { %>
  <p>Sepetinizde ürün bulunmamaktadır.</p>
<% } %>

<h2>Siparişleriniz</h2>
<% if (orders.length > 0) { %>
  <ul>
    <% orders.forEach(order => { %>
      <li>
        <strong>Sipariş Numarası: <%= order.id %></strong>
        <br>
        <strong>Ödeme Yöntemi:</strong> <%= order.payment_method %>
        <br>
        <strong>Gönderim Adresi:</strong> <%= order.shipping_address %>
        <br>
        <strong>Durum:</strong> <%= order.order_status %>
        <br>
        <strong>Toplam Fiyat:</strong> <%= order.total_price %> TL
        <br>
        <img src="<%= order.image_path %>" alt="<%= order.title %>" style="max-width: 200px;">
      </li>
    <% }); %>
  </ul>
<% } else { %>
  <p>Henüz siparişiniz yok.</p>
<% } %>


<h2>Mesajlarınız</h2>

<h3>Gelen Mesajlar</h3>
<% if (receivedMessages.length > 0) { %>
  <ul>
    <% receivedMessages.forEach(message => { %>
      <li>
        <p><%= message.content %></p>
        <p>Gönderen: <%= message.sender_username %></p>
        <p>Tarih: <%= message.sent_at %></p>
        
        <!-- Cevap Ver Butonu -->
        <button class="reply-button" data-message-id="<%= message.id %>">Cevapla</button>

        <!-- Cevap Formu -->
        <div class="reply-form" id="reply-form-<%= message.id %>" style="display: none;">
          <form method="POST" action="/messages/reply">
            <input type="hidden" name="message_id" value="<%= message.id %>">
            <textarea name="content" placeholder="Cevabınızı yazın..." required></textarea>
            <button type="submit">Gönder</button>
          </form>
        </div>
      </li>
    <% }); %>
  </ul>
<% } else { %>
  <p>Henüz gelen mesajınız yok.</p>
<% } %>

<h3>Giden Mesajlar</h3>
<% if (sentMessages.length > 0) { %>
  <ul>
    <% sentMessages.forEach(message => { %>
      <li>
        <p><%= message.content %></p>
        <p>Alıcı: <%= message.receiver_username %></p>
        <p>Tarih: <%= message.sent_at %></p>
      </li>
    <% }); %>
  </ul>
<% } else { %>
  <p>Henüz giden mesajınız yok.</p>
<% } %>


<h2>Profil Bilgilerinizi Güncelleyin</h2>
<form method="POST" action="/user/update-profile">
  <label for="first_name">Ad:</label>
  <input type="text" id="first_name" name="first_name" value="<%= user.first_name %>" required>
  <br>
  <label for="last_name">Soyad:</label>
  <input type="text" id="last_name" name="last_name" value="<%= user.last_name %>" required>
  <br>
  <label for="gender">Cinsiyet:</label>
  <select id="gender" name="gender">
    <option value="male" <%= user.gender === 'male' ? 'selected' : '' %>>Erkek</option>
    <option value="female" <%= user.gender === 'female' ? 'selected' : '' %>>Kadın</option>
    <option value="other" <%= user.gender === 'other' ? 'selected' : '' %>>Diğer</option>
  </select>
  <br>
  <button type="submit">Güncelle</button>
</form>



<script>
    // Mesaj Gönder Butonu ile Mesaj Formunu Gösterme
    document.querySelectorAll('.message-button').forEach(button => {
      button.addEventListener('click', function() {
        const listingId = this.getAttribute('data-listing-id');
        const messageForm = document.getElementById(`message-form-${listingId}`);
        messageForm.style.display = messageForm.style.display === 'none' ? 'block' : 'none';
      });
    });


     // Cevap Ver Butonu ile Cevap Formunu Gösterme
  document.querySelectorAll('.reply-button').forEach(button => {
    button.addEventListener('click', function() {
      const messageId = this.getAttribute('data-message-id');
      const replyForm = document.getElementById(`reply-form-${messageId}`);
      replyForm.style.display = replyForm.style.display === 'none' ? 'block' : 'none';
    });
  });
  </script>

<%- include('partials/footer') %>
